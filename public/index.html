<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CDMO Lead Discovery Platform</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
            --radius: 8px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #ffffff;
            color: var(--gray-900);
            line-height: 1.5;
            min-height: 100vh;
            display: flex;
        }

        /* Sidebar */
        .sidebar {
            width: 240px;
            background: var(--gray-50);
            border-right: 1px solid var(--gray-200);
            padding: 24px 16px;
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
            left: 0;
            top: 0;
            overflow-y: auto;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 0 8px;
            margin-bottom: 32px;
        }

        .logo-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 14px;
        }

        .logo-text {
            font-size: 18px;
            font-weight: 600;
            color: var(--gray-900);
        }

        .nav-section {
            margin-bottom: 24px;
        }

        .nav-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--gray-500);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 0 8px;
            margin-bottom: 8px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 8px;
            border-radius: 6px;
            color: var(--gray-700);
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .nav-item:hover {
            background: var(--gray-100);
            color: var(--gray-900);
        }

        .nav-item.active {
            background: white;
            color: var(--primary);
            box-shadow: var(--shadow-sm);
        }

        .nav-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .nav-badge {
            margin-left: auto;
            background: var(--primary);
            color: white;
            font-size: 11px;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 10px;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 240px;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: white;
            border-bottom: 1px solid var(--gray-200);
            padding: 16px 32px;
            display: flex;
            align-items: center;
            gap: 24px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .search-container {
            flex: 1;
            max-width: 480px;
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 10px 16px 10px 40px;
            border: 1px solid var(--gray-300);
            border-radius: var(--radius);
            font-size: 14px;
            transition: all 0.2s;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-400);
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-left: auto;
        }

        .btn-refresh {
            padding: 8px 16px;
            background: white;
            border: 1px solid var(--gray-300);
            border-radius: var(--radius);
            font-size: 14px;
            font-weight: 500;
            color: var(--gray-700);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-refresh:hover {
            background: var(--gray-50);
            border-color: var(--gray-400);
        }

        /* Content Area */
        .content {
            flex: 1;
            padding: 32px;
            background: white;
        }

        .page-title {
            font-size: 24px;
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: 8px;
        }

        .page-subtitle {
            font-size: 14px;
            color: var(--gray-600);
            margin-bottom: 32px;
        }

        /* Metrics Grid */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .metric-card {
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius);
            padding: 20px;
            transition: all 0.2s;
        }

        .metric-card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .metric-label {
            font-size: 12px;
            font-weight: 500;
            color: var(--gray-500);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .metric-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--gray-900);
            line-height: 1;
            margin-bottom: 12px;
        }

        .metric-change {
            font-size: 13px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .metric-change.positive {
            color: var(--success);
        }

        .metric-change.negative {
            color: var(--danger);
        }

        /* Filter Bar */
        .filter-bar {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 24px;
            padding: 16px;
            background: var(--gray-50);
            border-radius: var(--radius);
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-label {
            font-size: 13px;
            font-weight: 500;
            color: var(--gray-600);
        }

        .filter-select {
            padding: 6px 12px;
            border: 1px solid var(--gray-300);
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            background: white;
            color: var(--gray-700);
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .filter-badge {
            padding: 4px 10px;
            background: var(--primary);
            color: white;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
        }

        /* Data Table */
        .data-table-container {
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius);
            overflow: hidden;
        }

        .table-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .table-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--gray-900);
        }

        .table-actions {
            display: flex;
            gap: 8px;
        }

        .btn-action {
            padding: 6px 12px;
            background: white;
            border: 1px solid var(--gray-300);
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            color: var(--gray-700);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-action:hover {
            background: var(--gray-50);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            border: none;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            text-align: left;
            padding: 12px 20px;
            background: var(--gray-50);
            font-size: 12px;
            font-weight: 600;
            color: var(--gray-600);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid var(--gray-200);
        }

        .data-table td {
            padding: 16px 20px;
            border-bottom: 1px solid var(--gray-100);
            font-size: 14px;
            color: var(--gray-700);
        }

        .data-table tr:hover td {
            background: var(--gray-50);
        }

        .company-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .company-avatar {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
        }

        .company-details {
            display: flex;
            flex-direction: column;
        }

        .company-name {
            font-weight: 600;
            color: var(--gray-900);
            cursor: pointer;
        }

        .company-name:hover {
            color: var(--primary);
        }

        .company-meta {
            font-size: 12px;
            color: var(--gray-500);
        }

        .score-badge {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }

        .score-badge.tier-a {
            background: #dcfce7;
            color: #15803d;
        }

        .score-badge.tier-b {
            background: #fef3c7;
            color: #a16207;
        }

        .score-badge.tier-c {
            background: #fee2e2;
            color: #b91c1c;
        }

        .status-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            display: inline-block;
        }

        .status-badge.active {
            background: #dcfce7;
            color: #15803d;
        }

        .status-badge.pending {
            background: #fef3c7;
            color: #a16207;
        }

        .status-badge.stale {
            background: #fee2e2;
            color: #b91c1c;
        }

        /* Molecule Pills */
        .molecule-pills {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .molecule-pill {
            padding: 3px 8px;
            background: var(--gray-100);
            color: var(--gray-700);
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }

        /* Details Panel */
        .details-panel {
            position: fixed;
            right: -480px;
            top: 0;
            width: 480px;
            height: 100vh;
            background: white;
            border-left: 1px solid var(--gray-200);
            transition: right 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
        }

        .details-panel.open {
            right: 0;
            box-shadow: -4px 0 24px rgba(0, 0, 0, 0.1);
        }

        .panel-header {
            padding: 20px;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            background: white;
            z-index: 10;
        }

        .panel-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--gray-900);
        }

        .panel-close {
            width: 32px;
            height: 32px;
            border: 1px solid var(--gray-300);
            border-radius: 6px;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .panel-close:hover {
            background: var(--gray-50);
        }

        .panel-content {
            padding: 20px;
        }

        .panel-section {
            margin-bottom: 28px;
        }

        .panel-section-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .info-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .info-label {
            font-size: 11px;
            font-weight: 500;
            color: var(--gray-500);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .info-value {
            font-size: 14px;
            font-weight: 500;
            color: var(--gray-900);
        }

        /* Contact List */
        .contact-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .contact-item {
            padding: 12px;
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.2s;
        }

        .contact-item:hover {
            background: var(--gray-50);
            border-color: var(--gray-300);
        }

        .contact-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
        }

        .contact-info {
            flex: 1;
        }

        .contact-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--gray-900);
        }

        .contact-title {
            font-size: 12px;
            color: var(--gray-600);
        }

        .contact-actions {
            display: flex;
            gap: 8px;
        }

        .contact-action {
            width: 32px;
            height: 32px;
            border: 1px solid var(--gray-200);
            border-radius: 6px;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--gray-600);
        }

        .contact-action:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* Loading State */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 48px;
            color: var(--gray-500);
        }

        .spinner {
            width: 24px;
            height: 24px;
            border: 2px solid var(--gray-300);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 48px;
        }

        .empty-icon {
            width: 64px;
            height: 64px;
            margin: 0 auto 16px;
            background: var(--gray-100);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--gray-400);
        }

        .empty-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: 8px;
        }

        .empty-text {
            font-size: 14px;
            color: var(--gray-600);
        }

        /* Pagination */
        .pagination {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            border-top: 1px solid var(--gray-200);
        }

        .pagination-info {
            font-size: 13px;
            color: var(--gray-600);
        }

        .pagination-controls {
            display: flex;
            gap: 8px;
        }

        .page-btn {
            padding: 6px 12px;
            border: 1px solid var(--gray-300);
            background: white;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            color: var(--gray-700);
            cursor: pointer;
            transition: all 0.2s;
        }

        .page-btn:hover:not(:disabled) {
            background: var(--gray-50);
        }

        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .page-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .tab-btn {
    padding: 8px 16px;
    background: white;
    border: 1px solid var(--gray-300);
    border-radius: 6px;
    font-size: 14px;
    font-weight: 500;
    color: var(--gray-700);
    cursor: pointer;
    transition: all 0.2s;
    margin-right: 8px;
}

.tab-btn:hover {
    background: var(--gray-50);
}

.tab-btn.active {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
}

.tab-content {
    animation: fadeIn 0.3s ease;
}

.timeline-item {
    position: relative;
}

.discovery-tabs {
    display: flex;
    gap: 8px;
    border-bottom: 1px solid var(--gray-200);
    padding-bottom: 16px;
}
    </style>
</head>
<body>
    <!-- Sidebar Navigation -->
    <aside class="sidebar">
        <div class="logo">
            <div class="logo-icon">CD</div>
            <div class="logo-text">CDMO Discovery</div>
        </div>

        <nav class="nav-section">
            <div class="nav-title">Main</div>
            <a class="nav-item active" data-page="dashboard">
                <span class="nav-icon">📊</span>
                <span>Dashboard</span>
            </a>
            <a class="nav-item" data-page="leads">
                <span class="nav-icon">🎯</span>
                <span>Lead Pipeline</span>
                <span class="nav-badge" id="leadCount">0</span>
            </a>
            <a class="nav-item" data-page="molecules">
                <span class="nav-icon">🧬</span>
                <span>Molecules</span>
            </a>
            <a class="nav-item" data-page="trials">
                <span class="nav-icon">🔬</span>
                <span>Clinical Trials</span>
            </a>
        </nav>

        <nav class="nav-section">
    <div class="nav-title">Discovery</div>
    <a class="nav-item" data-page="discovery">
        <span class="nav-icon">🔍</span>
        <span>Pre-Phase 1</span>
        <span class="nav-badge" id="discoveryCount">0</span>
    </a>
    <a class="nav-item" data-page="compounds">
        <span class="nav-icon">⚗️</span>
        <span>Early Compounds</span>
    </a>
    <a class="nav-item" data-page="grants">
        <span class="nav-icon">💵</span>
        <span>Grant Tracking</span>
    </a>
</nav>

        <nav class="nav-section">
            <div class="nav-title">Intelligence</div>
            <a class="nav-item" data-page="patents">
                <span class="nav-icon">📋</span>
                <span>Patents</span>
            </a>
            <a class="nav-item" data-page="funding">
                <span class="nav-icon">💰</span>
                <span>Funding Rounds</span>
            </a>
            <a class="nav-item" data-page="signals">
                <span class="nav-icon">📡</span>
                <span>Market Signals</span>
            </a>
        </nav>

        <nav class="nav-section">
            <div class="nav-title">Outreach</div>
            <a class="nav-item" data-page="contacts">
                <span class="nav-icon">👥</span>
                <span>Contacts</span>
            </a>
            <a class="nav-item" data-page="campaigns">
                <span class="nav-icon">📧</span>
                <span>Campaigns</span>
            </a>
        </nav>
    </aside>

    <!-- Main Content Area -->
    <main class="main-content">
        <!-- Header -->
        <header class="header">
            <div class="search-container">
                <svg class="search-icon" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <circle cx="11" cy="11" r="8"></circle>
                    <path d="m21 21-4.35-4.35"></path>
                </svg>
                <input type="text" class="search-input" placeholder="Search companies, molecules, or contacts..." id="globalSearch">
            </div>
            <div class="header-actions">
                <button class="btn-refresh" id="refreshData">
                    <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path d="M1 4v6h6M23 20v-6h-6"/>
                        <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4-4.64 4.36A9 9 0 0 1 3.51 15"/>
                    </svg>
                    Refresh
                </button>
            </div>
        </header>

        <!-- Content Area -->
        <div class="content" id="contentArea">
            <!-- Dashboard View (Default) -->
            <div id="dashboardView">
                <h1 class="page-title">Discovery Dashboard</h1>
                <p class="page-subtitle">Real-time overview of Phase 1 opportunities and CDMO prospects</p>

                <!-- Key Metrics -->
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-label">Total Companies</div>
                        <div class="metric-value" id="metricCompanies">0</div>
                        <div class="metric-change positive">
                            <span>↑</span>
                            <span id="metricCompaniesChange">0 this week</span>
                        </div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Tier A Prospects</div>
                        <div class="metric-value" id="metricTierA">0</div>
                        <div class="metric-change positive">
                            <span>↑</span>
                            <span id="metricTierAChange">0 qualified</span>
                        </div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Phase 1 Trials</div>
                        <div class="metric-value" id="metricPhase1">0</div>
                        <div class="metric-change positive">
                            <span>↑</span>
                            <span id="metricPhase1Change">0 new</span>
                        </div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Need CDMO</div>
                        <div class="metric-value" id="metricNeedsCDMO">0</div>
                        <div class="metric-change positive">
                            <span>↑</span>
                            <span id="metricNeedsCDMOChange">0 identified</span>
                        </div>
                    </div>
                </div>

                <!-- Filter Bar -->
                <div class="filter-bar">
                    <div class="filter-group">
                        <span class="filter-label">Priority Tier:</span>
                        <select class="filter-select" id="filterTier">
                            <option value="">All Tiers</option>
                            <option value="A">Tier A</option>
                            <option value="B">Tier B</option>
                            <option value="C">Tier C</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <span class="filter-label">Phase:</span>
                        <select class="filter-select" id="filterPhase">
                            <option value="">All Phases</option>
                            <option value="phase1">Phase 1</option>
                            <option value="ind">IND-Enabling</option>
                            <option value="preclinical">Preclinical</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <span class="filter-label">Funding:</span>
                        <select class="filter-select" id="filterFunding">
                            <option value="">All</option>
                            <option value="recent">Recent (<18 months)</option>
                            <option value="none">No funding</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <span class="filter-label">Employees:</span>
                        <select class="filter-select" id="filterEmployees">
                            <option value="">All Sizes</option>
                            <option value="1-50">1-50</option>
                            <option value="51-250">51-250</option>
                            <option value="251-500">251-500</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <span class="filter-badge" id="excludeStale">
                            Exclude Stale
                            <span>✓</span>
                        </span>
                    </div>
                </div>

                <!-- Lead Pipeline Table -->
                <div class="data-table-container">
                    <div class="table-header">
                        <h3 class="table-title">Lead Pipeline</h3>
                        <div class="table-actions">
                            <button class="btn-action" id="exportLeads">
                                <span>↓</span>
                                Export
                            </button>
                            <button class="btn-action btn-primary" id="addLead">
                                <span>+</span>
                                Add Lead
                            </button>
                        </div>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Company</th>
                                <th>Score</th>
                                <th>Phase</th>
                                <th>Molecules</th>
                                <th>Funding</th>
                                <th>Employees</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="leadsTableBody">
                            <tr>
                                <td colspan="8" class="loading">
                                    <div class="spinner"></div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    <div class="pagination">
                        <div class="pagination-info">
                            Showing <span id="showingStart">0</span> to <span id="showingEnd">0</span> of <span id="totalResults">0</span> results
                        </div>
                        <div class="pagination-controls">
                            <button class="page-btn" id="prevPage" disabled>Previous</button>
                            <button class="page-btn active">1</button>
                            <button class="page-btn">2</button>
                            <button class="page-btn">3</button>
                            <button class="page-btn" id="nextPage">Next</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Details Panel -->
    <div class="details-panel" id="detailsPanel">
        <div class="panel-header">
            <h2 class="panel-title" id="panelTitle">Company Details</h2>
            <button class="panel-close" id="closePanel">✕</button>
        </div>
        <div class="panel-content" id="panelContent">
            <!-- Content will be dynamically loaded -->
        </div>
    </div>




<script>
    // dashboard.js - CDMO Lead Discovery Platform Frontend - Complete Implementation

// API Configuration
const API_BASE = 'http://localhost:5050/api';

// State Management
let currentPage = 1;
let currentFilters = {
    priorityTier: '',
    hasPhase1: null,
    needsCDMO: null,
    excludeStale: true,
    search: ''
};
let currentView = 'dashboard';
let allCompanies = [];
let allMolecules = [];
let allTrials = [];
let allContacts = [];

// Initialize Application
document.addEventListener('DOMContentLoaded', function() {
    loadDashboard();
    setupEventListeners();
    startAutoRefresh();
});

// Setup Event Listeners
function setupEventListeners() {
    // Navigation
    document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', function(e) {
            e.preventDefault();
            const page = this.dataset.page;
            navigateToPage(page);
        });
    });

    // Global Search
    const searchInput = document.getElementById('globalSearch');
    if (searchInput) {
        searchInput.addEventListener('input', debounce(function(e) {
            currentFilters.search = e.target.value;
            if (currentView === 'dashboard' || currentView === 'leads') {
                loadLeads();
            }
        }, 500));
    }

    // Dashboard Filters
    const filterTier = document.getElementById('filterTier');
    if (filterTier) {
        filterTier.addEventListener('change', function(e) {
            currentFilters.priorityTier = e.target.value;
            loadLeads();
        });
    }

    const excludeStale = document.getElementById('excludeStale');
    if (excludeStale) {
        excludeStale.addEventListener('click', function() {
            currentFilters.excludeStale = !currentFilters.excludeStale;
            this.querySelector('span').textContent = currentFilters.excludeStale ? '✓' : '';
            loadLeads();
        });
    }

    // Refresh Button
    const refreshBtn = document.getElementById('refreshData');
    if (refreshBtn) {
        refreshBtn.addEventListener('click', async function() {
            this.disabled = true;
            this.innerHTML = '<span class="spinner" style="width: 16px; height: 16px;"></span> Refreshing...';
            
            try {
                await fetch(`${API_BASE}/refresh/all`, { method: 'POST' });
                await loadCurrentView();
            } catch (error) {
                showError('Failed to refresh data');
            } finally {
                this.disabled = false;
                this.innerHTML = `<svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M1 4v6h6M23 20v-6h-6"/><path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4-4.64 4.36A9 9 0 0 1 3.51 15"/></svg> Refresh`;
            }
        });
    }

    // Export Button
    const exportBtn = document.getElementById('exportLeads');
    if (exportBtn) {
        exportBtn.addEventListener('click', function() {
            exportLeads();
        });
    }

    // Details Panel
    const closePanel = document.getElementById('closePanel');
    if (closePanel) {
        closePanel.addEventListener('click', function() {
            closeDetailsPanel();
        });
    }

    // Pagination
    const prevPage = document.getElementById('prevPage');
    if (prevPage) {
        prevPage.addEventListener('click', function() {
            if (currentPage > 1) {
                currentPage--;
                loadCurrentView();
            }
        });
    }

    const nextPage = document.getElementById('nextPage');
    if (nextPage) {
        nextPage.addEventListener('click', function() {
            currentPage++;
            loadCurrentView();
        });
    }
}

// Navigation Handler
function navigateToPage(page) {
    document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
    });
    
    const pageItem = document.querySelector(`[data-page="${page}"]`);
    if (pageItem) {
        pageItem.classList.add('active');
    }
    
    currentView = page;
    currentPage = 1; // Reset pagination when switching views
    loadCurrentView();
}


// Load Current View
async function loadCurrentView() {
    const contentArea = document.getElementById('contentArea');
    if (!contentArea) return;

    switch(currentView) {
        case 'dashboard':
            await loadDashboard();
            break;
        case 'leads':
            await loadLeadsView();
            break;
        case 'molecules':
            await loadMoleculesView();
            break;
        case 'trials':
            await loadTrialsView();
            break;
        case 'patents':
            await loadPatents();
            break;
        case 'funding':
            await loadFundingView();
            break;
        case 'signals':
            await loadSignalsView();
            break;
        case 'contacts':
            await loadContactsView();
            break;
        case 'campaigns':
            await loadCampaignsView();
            break;
        case 'discovery':
            loadDiscoveryView();
            break;
        case 'compounds':
            loadCompounds();
            break;
        case 'grants':
            loadGrants();
            break;
        default:
            showComingSoon();
    }
}

// ============= DASHBOARD VIEW =============
async function loadDashboard() {
    const contentArea = document.getElementById('contentArea');
    
    contentArea.innerHTML = `
        <div id="dashboardView">
            <h1 class="page-title">Discovery Dashboard</h1>
            <p class="page-subtitle">Real-time overview of Phase 1 opportunities and CDMO prospects</p>

            <!-- Key Metrics -->
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-label">Total Companies</div>
                    <div class="metric-value" id="metricCompanies">-</div>
                    <div class="metric-change positive">
                        <span>↑</span>
                        <span id="metricCompaniesChange">Loading...</span>
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Tier A Prospects</div>
                    <div class="metric-value" id="metricTierA">-</div>
                    <div class="metric-change positive">
                        <span>↑</span>
                        <span id="metricTierAChange">Loading...</span>
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Phase 1 Trials</div>
                    <div class="metric-value" id="metricPhase1">-</div>
                    <div class="metric-change positive">
                        <span>↑</span>
                        <span id="metricPhase1Change">Loading...</span>
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Need CDMO</div>
                    <div class="metric-value" id="metricNeedsCDMO">-</div>
                    <div class="metric-change positive">
                        <span>↑</span>
                        <span id="metricNeedsCDMOChange">Loading...</span>
                    </div>
                </div>
            </div>

            <!-- Filter Bar -->
            <div class="filter-bar">
                <div class="filter-group">
                    <span class="filter-label">Priority Tier:</span>
                    <select class="filter-select" id="filterTier">
                        <option value="">All Tiers</option>
                        <option value="A">Tier A</option>
                        <option value="B">Tier B</option>
                        <option value="C">Tier C</option>
                    </select>
                </div>
                <div class="filter-group">
                    <span class="filter-label">Phase:</span>
                    <select class="filter-select" id="filterPhase">
                        <option value="">All Phases</option>
                        <option value="phase1">Phase 1</option>
                        <option value="ind">IND-Enabling</option>
                        <option value="preclinical">Preclinical</option>
                    </select>
                </div>
                <div class="filter-group">
                    <span class="filter-badge" id="excludeStale">
                        Exclude Stale
                        <span>✓</span>
                    </span>
                </div>
            </div>

            <!-- Lead Pipeline Table -->
            <div class="data-table-container">
                <div class="table-header">
                    <h3 class="table-title">Lead Pipeline</h3>
                    <div class="table-actions">
                        <button class="btn-action" id="exportLeads">
                            <span>↓</span>
                            Export CSV
                        </button>
                    </div>
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Company</th>
                            <th>Score</th>
                            <th>Phase</th>
                            <th>Molecules</th>
                            <th>Funding</th>
                            <th>Employees</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="leadsTableBody">
                        <tr><td colspan="8" class="loading"><div class="spinner"></div></td></tr>
                    </tbody>
                </table>
                <div class="pagination" id="paginationContainer"></div>
            </div>
        </div>
    `;

    // Re-attach event listeners for dynamically created elements
    setupDashboardEventListeners();
    
    // Load data
    try {
        const statsResponse = await fetch(`${API_BASE}/stats/dashboard`);
        if (!statsResponse.ok) throw new Error('Failed to fetch stats');
        const stats = await statsResponse.json();

        // Update metrics
        updateMetric('metricCompanies', stats.overview.totalCompanies);
        updateMetric('metricTierA', stats.overview.tierACompanies);
        updateMetric('metricPhase1', stats.trials.phase1Trials);
        updateMetric('metricNeedsCDMO', stats.overview.companiesNeedingCDMO);

        updateText('metricCompaniesChange', `${stats.recentActivity.last7Days.companies} this week`);
        updateText('metricTierAChange', `${stats.overview.tierACompanies} qualified`);
        updateText('metricPhase1Change', `${stats.recentActivity.last7Days.trials} new`);
        updateText('metricNeedsCDMOChange', `${stats.overview.companiesNeedingCDMO} identified`);

        updateText('leadCount', stats.overview.scoredCompanies);

        await loadLeads();
    } catch (error) {
        console.error('Error loading dashboard:', error);
        showError('Failed to load dashboard data');
    }
}

// ============= LEADS VIEW =============
async function loadLeadsView() {
    const contentArea = document.getElementById('contentArea');
    
    contentArea.innerHTML = `
        <div id="leadsView">
            <h1 class="page-title">Lead Pipeline Management</h1>
            <p class="page-subtitle">Manage and track all potential CDMO opportunities</p>

            <div class="filter-bar">
                <div class="filter-group">
                    <span class="filter-label">Score Range:</span>
                    <input type="number" class="filter-input" id="minScore" placeholder="Min" style="width: 80px;">
                    <span>-</span>
                    <input type="number" class="filter-input" id="maxScore" placeholder="Max" style="width: 80px;">
                </div>
                <div class="filter-group">
                    <span class="filter-label">Priority:</span>
                    <select class="filter-select" id="leadFilterTier">
                        <option value="">All Tiers</option>
                        <option value="A">Tier A Only</option>
                        <option value="B">Tier B Only</option>
                        <option value="C">Tier C Only</option>
                    </select>
                </div>
                <button class="btn-action btn-primary" id="applyLeadFilters">Apply Filters</button>
            </div>

            <div class="data-table-container">
                <div class="table-header">
                    <h3 class="table-title">All Leads</h3>
                    <div class="table-actions">
                        <button class="btn-action" id="rescoreAll">
                            <span>🎯</span>
                            Rescore All
                        </button>
                        <button class="btn-action btn-primary" id="addManualLead">
                            <span>+</span>
                            Add Lead
                        </button>
                    </div>
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Company</th>
                            <th>Overall Score</th>
                            <th>Priority Tier</th>
                            <th>Phase 1 Ready</th>
                            <th>Funding Score</th>
                            <th>Outsourcing Score</th>
                            <th>Can Pay</th>
                            <th>Needs CDMO</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="leadsTableBody">
                        <tr><td colspan="9" class="loading"><div class="spinner"></div></td></tr>
                    </tbody>
                </table>
                <div class="pagination" id="paginationContainer"></div>
            </div>
        </div>
    `;

    await loadLeads();
}

// ============= MOLECULES VIEW =============
async function loadMoleculesView() {
    const contentArea = document.getElementById('contentArea');
    
    contentArea.innerHTML = `
        <div id="moleculesView">
            <h1 class="page-title">Molecule Intelligence</h1>
            <p class="page-subtitle">Track molecules entering IND-enabling and Phase 1</p>

            <div class="filter-bar">
                <div class="filter-group">
                    <span class="filter-label">Modality:</span>
                    <select class="filter-select" id="modalityFilter">
                        <option value="">All Modalities</option>
                        <option value="Small Molecule">Small Molecule</option>
                        <option value="Antibody">Antibody</option>
                        <option value="Cell Therapy">Cell Therapy</option>
                        <option value="Gene Therapy">Gene Therapy</option>
                    </select>
                </div>
                <div class="filter-group">
                    <span class="filter-label">Has Structure:</span>
                    <select class="filter-select" id="structureFilter">
                        <option value="">All</option>
                        <option value="1">With Structure</option>
                        <option value="0">No Structure</option>
                    </select>
                </div>
                <button class="btn-action btn-primary" id="enrichMolecules">
                    <span>🧬</span>
                    Enrich from PubChem
                </button>
            </div>

            <div class="data-table-container">
                <div class="table-header">
                    <h3 class="table-title">Molecules Database</h3>
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Molecule Name</th>
                            <th>Company</th>
                            <th>Target</th>
                            <th>Indication</th>
                            <th>Modality</th>
                            <th>Stage</th>
                            <th>PubChem</th>
                            <th>Process Chemistry</th>
                        </tr>
                    </thead>
                    <tbody id="moleculesTableBody">
                        <tr><td colspan="8" class="loading"><div class="spinner"></div></td></tr>
                    </tbody>
                </table>
                <div class="pagination" id="paginationContainer"></div>
            </div>
        </div>
    `;

    await loadMolecules();
}

// ============= TRIALS VIEW =============
async function loadTrialsView() {
    const contentArea = document.getElementById('contentArea');
    
    contentArea.innerHTML = `
        <div id="trialsView">
            <h1 class="page-title">Clinical Trials Tracker</h1>
            <p class="page-subtitle">Monitor Phase 1 and IND-enabling trials</p>

            <div class="filter-bar">
                <div class="filter-group">
                    <span class="filter-label">Status:</span>
                    <select class="filter-select" id="trialStatusFilter">
                        <option value="">All Status</option>
                        <option value="Not yet recruiting">Not Yet Recruiting</option>
                        <option value="Recruiting">Recruiting</option>
                        <option value="Active">Active</option>
                    </select>
                </div>
                <div class="filter-group">
                    <span class="filter-label">Location:</span>
                    <select class="filter-select" id="trialLocationFilter">
                        <option value="">All Locations</option>
                        <option value="US">US Sites</option>
                        <option value="EU">EU Sites</option>
                    </select>
                </div>
                <button class="btn-action btn-primary" id="fetchNewTrials">
                    <span>🔄</span>
                    Fetch New Trials
                </button>
            </div>

            <div class="data-table-container">
                <div class="table-header">
                    <h3 class="table-title">Active Clinical Trials</h3>
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Trial ID</th>
                            <th>Company</th>
                            <th>Phase</th>
                            <th>Status</th>
                            <th>Start Date</th>
                            <th>Locations</th>
                            <th>Enrollment</th>
                            <th>Last Update</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="trialsTableBody">
                        <tr><td colspan="9" class="loading"><div class="spinner"></div></td></tr>
                    </tbody>
                </table>
                <div class="pagination" id="paginationContainer"></div>
            </div>
        </div>
    `;

    await loadTrials();
}

// ============= PATENTS VIEW =============
async function loadPatentsView() {
    const contentArea = document.getElementById('contentArea');
    
    contentArea.innerHTML = `
        <div id="patentsView">
            <h1 class="page-title">Patent Intelligence</h1>
            <p class="page-subtitle">Process chemistry and manufacturing patents</p>

            <div class="filter-bar">
                <div class="filter-group">
                    <span class="filter-label">Date Range:</span>
                    <input type="date" class="filter-input" id="patentStartDate">
                    <span>to</span>
                    <input type="date" class="filter-input" id="patentEndDate">
                </div>
                <div class="filter-group">
                    <span class="filter-badge" id="processChemOnly">
                        Process Chemistry Only
                        <span>✓</span>
                    </span>
                </div>
                <button class="btn-action btn-primary" id="searchPatents">
                    <span>🔍</span>
                    Search Patents
                </button>
            </div>

            <div class="data-table-container">
                <div class="table-header">
                    <h3 class="table-title">Recent Patents</h3>
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Patent Number</th>
                            <th>Title</th>
                            <th>Assignee</th>
                            <th>Filing Date</th>
                            <th>Process Relevant</th>
                            <th>Claims</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="patentsTableBody">
                        <tr><td colspan="7" class="loading"><div class="spinner"></div></td></tr>
                    </tbody>
                </table>
                <div class="pagination" id="paginationContainer"></div>
            </div>
        </div>
    `;

    await loadPatents();
}

// ============= FUNDING VIEW =============
async function loadFundingView() {
    const contentArea = document.getElementById('contentArea');
    
    contentArea.innerHTML = `
        <div id="fundingView">
            <h1 class="page-title">Funding Tracker</h1>
            <p class="page-subtitle">Monitor funding rounds and financial capability</p>

            <div class="metrics-grid" style="margin-bottom: 24px;">
                <div class="metric-card">
                    <div class="metric-label">Total Tracked</div>
                    <div class="metric-value" id="totalFundingRounds">0</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Last 18 Months</div>
                    <div class="metric-value" id="recentFunding">0</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Total Raised</div>
                    <div class="metric-value" id="totalRaised">$0</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Average Round</div>
                    <div class="metric-value" id="avgRound">$0</div>
                </div>
            </div>

            <div class="data-table-container">
                <div class="table-header">
                    <h3 class="table-title">Recent Funding Rounds</h3>
                    <div class="table-actions">
                        <button class="btn-action btn-primary" id="addFunding">
                            <span>+</span>
                            Add Funding
                        </button>
                    </div>
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Company</th>
                            <th>Round Type</th>
                            <th>Amount</th>
                            <th>Date</th>
                            <th>Lead Investor</th>
                            <th>Source</th>
                        </tr>
                    </thead>
                    <tbody id="fundingTableBody">
                        <tr><td colspan="6" class="loading"><div class="spinner"></div></td></tr>
                    </tbody>
                </table>
                <div class="pagination" id="paginationContainer"></div>
            </div>
        </div>
    `;

    await loadFunding();
}

// ============= SIGNALS VIEW =============
async function loadSignalsView() {
    const contentArea = document.getElementById('contentArea');
    
    contentArea.innerHTML = `
        <div id="signalsView">
            <h1 class="page-title">Market Signals</h1>
            <p class="page-subtitle">Track IND, hiring, partnerships, and other signals</p>

            <div class="filter-bar">
                <div class="filter-group">
                    <span class="filter-label">Signal Type:</span>
                    <select class="filter-select" id="signalTypeFilter">
                        <option value="">All Types</option>
                        <option value="ind">IND Signals</option>
                        <option value="clinical_trial">Clinical Trial</option>
                        <option value="patent">Patent</option>
                        <option value="funding">Funding</option>
                        <option value="hiring">Hiring</option>
                        <option value="conference">Conference</option>
                        <option value="press">Press</option>
                        <option value="cdmo">CDMO</option>
                    </select>
                </div>
                <div class="filter-group">
                    <span class="filter-label">Strength:</span>
                    <select class="filter-select" id="signalStrengthFilter">
                        <option value="">All</option>
                        <option value="strong">Strong</option>
                        <option value="medium">Medium</option>
                        <option value="weak">Weak</option>
                    </select>
                </div>
                <button class="btn-action btn-primary" id="addSignal">
                    <span>+</span>
                    Add Signal
                </button>
            </div>

            <div class="data-table-container">
                <div class="table-header">
                    <h3 class="table-title">Recent Signals</h3>
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Company</th>
                            <th>Type</th>
                            <th>Strength</th>
                            <th>Title</th>
                            <th>Source</th>
                            <th>Relevance</th>
                        </tr>
                    </thead>
                    <tbody id="signalsTableBody">
                        <tr><td colspan="7" class="loading"><div class="spinner"></div></td></tr>
                    </tbody>
                </table>
                <div class="pagination" id="paginationContainer"></div>
            </div>
        </div>
    `;

    await loadSignals();
}

// ============= CONTACTS VIEW =============
async function loadContactsView() {
    const contentArea = document.getElementById('contentArea');
    
    contentArea.innerHTML = `
        <div id="contactsView">
            <h1 class="page-title">Executive Contacts</h1>
            <p class="page-subtitle">VP, CEO, and Director contacts for outreach</p>

            <div class="filter-bar">
                <div class="filter-group">
                    <span class="filter-label">Title:</span>
                    <select class="filter-select" id="titleFilter">
                        <option value="">All Titles</option>
                        <option value="CEO">CEO</option>
                        <option value="VP">VP Level</option>
                        <option value="Director">Director</option>
                        <option value="Head">Head/Chief</option>
                    </select>
                </div>
                <div class="filter-group">
                    <span class="filter-badge" id="verifiedOnly">
                        Verified Only
                        <span></span>
                    </span>
                </div>
                <button class="btn-action btn-primary" id="discoverMoreContacts">
                    <span>🔍</span>
                    Discover Contacts
                </button>
            </div>

            <div class="data-table-container">
                <div class="table-header">
                    <h3 class="table-title">Contact Database</h3>
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Company</th>
                            <th>Title</th>
                            <th>Department</th>
                            <th>Email</th>
                            <th>LinkedIn</th>
                            <th>Confidence</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="contactsTableBody">
                        <tr><td colspan="8" class="loading"><div class="spinner"></div></td></tr>
                    </tbody>
                </table>
                <div class="pagination" id="paginationContainer"></div>
            </div>
        </div>
    `;

    await loadContacts();
}

// ============= CAMPAIGNS VIEW =============
async function loadCampaignsView() {
    const contentArea = document.getElementById('contentArea');
    
    contentArea.innerHTML = `
        <div id="campaignsView">
            <h1 class="page-title">Outreach Campaigns</h1>
            <p class="page-subtitle">Manage BD outreach and engagement campaigns</p>

            <div class="metrics-grid" style="margin-bottom: 24px;">
                <div class="metric-card">
                    <div class="metric-label">Active Campaigns</div>
                    <div class="metric-value">3</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Contacts Reached</div>
                    <div class="metric-value">147</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Response Rate</div>
                    <div class="metric-value">24%</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Qualified Leads</div>
                    <div class="metric-value">12</div>
                </div>
            </div>

            <div class="data-table-container">
                <div class="table-header">
                    <h3 class="table-title">Campaign Management</h3>
                    <div class="table-actions">
                        <button class="btn-action btn-primary">
                            <span>+</span>
                            New Campaign
                        </button>
                    </div>
                </div>
                <div style="padding: 48px; text-align: center; color: var(--gray-600);">
                    <div style="font-size: 48px; margin-bottom: 16px;">📧</div>
                    <h3 style="font-size: 18px; font-weight: 600; color: var(--gray-900); margin-bottom: 8px;">
                        Campaign Management Coming Soon
                    </h3>
                    <p style="font-size: 14px;">
                        Automated outreach campaigns with email sequences and tracking will be available soon.
                    </p>
                </div>
            </div>
        </div>
    `;
}

// ============= DATA LOADING FUNCTIONS =============

async function loadLeads() {
    try {
        const params = new URLSearchParams({
            page: currentPage,
            pageSize: 10,
            ...Object.fromEntries(Object.entries(currentFilters).filter(([_, v]) => v !== null && v !== ''))
        });

        const response = await fetch(`${API_BASE}/leads?${params}`);
        if (!response.ok) throw new Error('Failed to fetch leads');
        
        const data = await response.json();
        const tbody = document.getElementById('leadsTableBody');
        if (!tbody) return;

        if (!data.leads || data.leads.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="9">
                        <div class="empty-state">
                            <div class="empty-icon">📊</div>
                            <div class="empty-title">No leads found</div>
                            <div class="empty-text">Try adjusting your filters or refresh the data</div>
                        </div>
                    </td>
                </tr>
            `;
            updatePagination(0, 0, 0);
            return;
        }

        tbody.innerHTML = data.leads.map(lead => createLeadRow(lead)).join('');
        updatePagination(data.page, data.pageSize, data.total);
        
    } catch (error) {
        console.error('Error loading leads:', error);
        showError('Failed to load leads');
    }
}

async function loadMolecules() {
    try {
        const response = await fetch(`${API_BASE}/leads?page=${currentPage}&pageSize=25`);
        if (!response.ok) throw new Error('Failed to fetch data');
        
        const data = await response.json();
        const tbody = document.getElementById('moleculesTableBody');
        if (!tbody) return;

        const molecules = [];
        for (const company of data.leads) {
            const detailResponse = await fetch(`${API_BASE}/leads/${company.id}`);
            if (detailResponse.ok) {
                const details = await detailResponse.json();
                details.molecules.forEach(mol => {
                    molecules.push({ ...mol, companyName: company.name });
                });
            }
        }

        if (molecules.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="8">
                        <div class="empty-state">
                            <div class="empty-icon">🧬</div>
                            <div class="empty-title">No molecules tracked</div>
                            <div class="empty-text">Molecules will appear as companies enter IND/Phase 1</div>
                        </div>
                    </td>
                </tr>
            `;
            return;
        }

        tbody.innerHTML = molecules.map(mol => `
            <tr>
                <td><strong>${escapeHtml(mol.name)}</strong></td>
                <td>${escapeHtml(mol.companyName)}</td>
                <td>${escapeHtml(mol.target || '-')}</td>
                <td>${escapeHtml(mol.indication || '-')}</td>
                <td>${escapeHtml(mol.modality || '-')}</td>
                <td><span class="status-badge active">${escapeHtml(mol.development_stage || 'Unknown')}</span></td>
                <td>${mol.pubchem_cid ? `<a href="https://pubchem.ncbi.nlm.nih.gov/compound/${mol.pubchem_cid}" target="_blank">View</a>` : '-'}</td>
                <td>${mol.process_chemistry_complexity || 'TBD'}</td>
            </tr>
        `).join('');
        
    } catch (error) {
        console.error('Error loading molecules:', error);
        showError('Failed to load molecules');
    }
}

async function loadTrials() {
    try {
        const response = await fetch(`${API_BASE}/leads?page=${currentPage}&pageSize=10`);
        if (!response.ok) throw new Error('Failed to fetch data');
        
        const data = await response.json();
        const tbody = document.getElementById('trialsTableBody');
        if (!tbody) return;

        const trials = [];
        for (const company of data.leads) {
            const detailResponse = await fetch(`${API_BASE}/leads/${company.id}`);
            if (detailResponse.ok) {
                const details = await detailResponse.json();
                details.trials.forEach(trial => {
                    trials.push({ ...trial, companyName: company.name });
                });
            }
        }

        if (trials.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="9">
                        <div class="empty-state">
                            <div class="empty-icon">🔬</div>
                            <div class="empty-title">No trials found</div>
                            <div class="empty-text">Clinical trials will appear as they are registered</div>
                        </div>
                    </td>
                </tr>
            `;
            return;
        }

        tbody.innerHTML = trials.map(trial => `
            <tr>
                <td><strong>${escapeHtml(trial.trial_id)}</strong></td>
                <td>${escapeHtml(trial.companyName)}</td>
                <td><span class="score-badge tier-a">${escapeHtml(trial.phase)}</span></td>
                <td><span class="status-badge ${trial.status === 'Recruiting' ? 'active' : 'pending'}">${escapeHtml(trial.status)}</span></td>
                <td>${trial.start_date ? new Date(trial.start_date).toLocaleDateString() : '-'}</td>
                <td>${escapeHtml(trial.locations || '-')}</td>
                <td>${trial.enrollment || '-'}</td>
                <td>${trial.last_update ? new Date(trial.last_update).toLocaleDateString() : '-'}</td>
                <td>
                    <a href="https://clinicaltrials.gov/study/${trial.trial_id}" target="_blank" class="btn-action">View</a>
                </td>
            </tr>
        `).join('');
        
    } catch (error) {
        console.error('Error loading trials:', error);
        showError('Failed to load trials');
    }
}

async function loadPatents() {
    try {
        const response = await fetch(`${API_BASE}/leads?page=1&pageSize=50`);
        if (!response.ok) throw new Error('Failed to fetch data');
        
        const data = await response.json();
        const tbody = document.getElementById('patentsTableBody');
        if (!tbody) return;

        const patents = [];
        for (const company of data.leads.slice(0, 5)) {
            const detailResponse = await fetch(`${API_BASE}/leads/${company.id}`);
            if (detailResponse.ok) {
                const details = await detailResponse.json();
                details.patents.forEach(patent => {
                    patents.push({ ...patent, companyName: company.name });
                });
            }
        }

        if (patents.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="7">
                        <div class="empty-state">
                            <div class="empty-icon">📋</div>
                            <div class="empty-title">No patents found</div>
                            <div class="empty-text">Process chemistry patents will be tracked here</div>
                        </div>
                    </td>
                </tr>
            `;
            return;
        }

        tbody.innerHTML = patents.map(patent => `
            <tr>
                <td><strong>${escapeHtml(patent.patent_number)}</strong></td>
                <td>${escapeHtml(patent.title)}</td>
                <td>${escapeHtml(patent.assignee || patent.companyName)}</td>
                <td>${patent.filing_date ? new Date(patent.filing_date).toLocaleDateString() : '-'}</td>
                <td>${patent.process_chemistry_relevant ? '✅ Yes' : '❌ No'}</td>
                <td>${patent.claims_count || '-'}</td>
                <td>
                    ${patent.url ? `<a href="${patent.url}" target="_blank" class="btn-action">View</a>` : '-'}
                </td>
            </tr>
        `).join('');
        
    } catch (error) {
        console.error('Error loading patents:', error);
        showError('Failed to load patents');
    }
}

async function loadFunding() {
    try {
        const response = await fetch(`${API_BASE}/stats/dashboard`);
        if (!response.ok) throw new Error('Failed to fetch stats');
        
        const stats = await stats.json();
        
        // Update metrics
        updateText('totalFundingRounds', stats.funding.companiesWithFunding);
        updateText('recentFunding', stats.funding.recentFunding);
        updateText('totalRaised', `$${(stats.funding.totalRaised / 1000000).toFixed(1)}M`);
        updateText('avgRound', `$${(stats.funding.totalRaised / stats.funding.companiesWithFunding / 1000000).toFixed(1)}M`);

        const leadsResponse = await fetch(`${API_BASE}/leads?page=1&pageSize=25`);
        if (!leadsResponse.ok) throw new Error('Failed to fetch leads');
        
        const data = await leadsResponse.json();
        const tbody = document.getElementById('fundingTableBody');
        if (!tbody) return;

        const funding = [];
        for (const company of data.leads.slice(0, 10)) {
            const detailResponse = await fetch(`${API_BASE}/leads/${company.id}`);
            if (detailResponse.ok) {
                const details = await detailResponse.json();
                details.funding.forEach(round => {
                    funding.push({ ...round, companyName: company.name });
                });
            }
        }

        if (funding.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6">
                        <div class="empty-state">
                            <div class="empty-icon">💰</div>
                            <div class="empty-title">No funding rounds tracked</div>
                            <div class="empty-text">Add funding rounds manually or wait for automatic updates</div>
                        </div>
                    </td>
                </tr>
            `;
            return;
        }

        tbody.innerHTML = funding.slice(0, 10).map(round => `
            <tr>
                <td><strong>${escapeHtml(round.companyName)}</strong></td>
                <td><span class="score-badge tier-b">${escapeHtml(round.round_type)}</span></td>
                <td><strong>$${round.amount_usd ? (round.amount_usd / 1000000).toFixed(1) + 'M' : 'Undisclosed'}</strong></td>
                <td>${new Date(round.date).toLocaleDateString()}</td>
                <td>${escapeHtml(round.lead_investor || '-')}</td>
                <td>${escapeHtml(round.source || 'Manual')}</td>
            </tr>
        `).join('');
        
    } catch (error) {
        console.error('Error loading funding:', error);
        showError('Failed to load funding data');
    }
}

async function loadSignals() {
    try {
        const response = await fetch(`${API_BASE}/leads?page=1&pageSize=25`);
        if (!response.ok) throw new Error('Failed to fetch data');
        
        const data = await response.json();
        const tbody = document.getElementById('signalsTableBody');
        if (!tbody) return;

        const signals = [];
        for (const company of data.leads.slice(0, 10)) {
            const detailResponse = await fetch(`${API_BASE}/leads/${company.id}`);
            if (detailResponse.ok) {
                const details = await detailResponse.json();
                details.signals.forEach(signal => {
                    signals.push({ ...signal, companyName: company.name });
                });
            }
        }

        if (signals.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="7">
                        <div class="empty-state">
                            <div class="empty-icon">📡</div>
                            <div class="empty-title">No signals detected</div>
                            <div class="empty-text">Market signals will appear here as they are discovered</div>
                        </div>
                    </td>
                </tr>
            `;
            return;
        }

        tbody.innerHTML = signals.slice(0, 20).map(signal => `
            <tr>
                <td>${new Date(signal.date).toLocaleDateString()}</td>
                <td><strong>${escapeHtml(signal.companyName)}</strong></td>
                <td><span class="molecule-pill">${escapeHtml(signal.signal_type)}</span></td>
                <td><span class="status-badge ${signal.signal_strength}">${escapeHtml(signal.signal_strength || 'medium')}</span></td>
                <td>${escapeHtml(signal.title)}</td>
                <td>${escapeHtml(signal.source)}</td>
                <td>${(signal.relevance_score * 100).toFixed(0)}%</td>
            </tr>
        `).join('');
        
    } catch (error) {
        console.error('Error loading signals:', error);
        showError('Failed to load signals');
    }
}

async function loadContacts() {
    try {
        const response = await fetch(`${API_BASE}/leads?page=1&pageSize=25`);
        if (!response.ok) throw new Error('Failed to fetch data');
        
        const data = await response.json();
        const tbody = document.getElementById('contactsTableBody');
        if (!tbody) return;

        const contacts = [];
        for (const company of data.leads.slice(0, 10)) {
            const detailResponse = await fetch(`${API_BASE}/leads/${company.id}`);
            if (detailResponse.ok) {
                const details = await detailResponse.json();
                details.contacts.forEach(contact => {
                    contacts.push({ ...contact, companyName: company.name, companyId: company.id });
                });
            }
        }

        if (contacts.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="8">
                        <div class="empty-state">
                            <div class="empty-icon">👥</div>
                            <div class="empty-title">No contacts found</div>
                            <div class="empty-text">Use the Discover Contacts feature to find executives</div>
                        </div>
                    </td>
                </tr>
            `;
            return;
        }

        tbody.innerHTML = contacts.map(contact => `
            <tr>
                <td><strong>${escapeHtml(contact.name)}</strong></td>
                <td>${escapeHtml(contact.companyName)}</td>
                <td><span class="score-badge tier-a">${escapeHtml(contact.title)}</span></td>
                <td>${escapeHtml(contact.department || '-')}</td>
                <td>${contact.email ? `<a href="mailto:${contact.email}">${contact.email}</a>` : '-'}</td>
                <td>${contact.linkedin_url ? `<a href="${contact.linkedin_url}" target="_blank">View</a>` : '-'}</td>
                <td>${(contact.confidence_score * 100).toFixed(0)}%</td>
                <td>
                    <button class="btn-action" onclick="openCompanyDetails(${contact.companyId})">Company</button>
                </td>
            </tr>
        `).join('');
        
    } catch (error) {
        console.error('Error loading contacts:', error);
        showError('Failed to load contacts');
    }
}

// ============= HELPER FUNCTIONS =============

function createLeadRow(lead) {
    const initials = getInitials(lead.name);
    const tierClass = (lead.priority_tier || 'c').toLowerCase();
    const statusClass = lead.is_stale ? 'stale' : (lead.needs_cdmo ? 'pending' : 'active');
    const statusText = lead.is_stale ? 'Stale' : (lead.needs_cdmo ? 'Needs CDMO' : 'Active');
    
    const cols = currentView === 'leads' ? `
        <td>
            <div class="company-info">
                <div class="company-avatar">${initials}</div>
                <div class="company-details">
                    <div class="company-name" data-company-id="${lead.id}">${escapeHtml(lead.name)}</div>
                    <div class="company-meta">${escapeHtml(lead.country || 'Unknown')}</div>
                </div>
            </div>
        </td>
        <td><strong>${lead.overall_score?.toFixed(0) || 0}</strong></td>
        <td><span class="score-badge tier-${tierClass}">Tier ${lead.priority_tier || '-'}</span></td>
        <td>${lead.phase1_readiness_score?.toFixed(0) || 0}</td>
        <td>${lead.funding_score?.toFixed(0) || 0}</td>
        <td>${lead.outsourcing_likelihood_score?.toFixed(0) || 0}</td>
        <td>${lead.can_pay ? '✅' : '❌'}</td>
        <td>${lead.needs_cdmo ? '✅' : '❌'}</td>
        <td>
            <button class="btn-action view-company" data-company-id="${lead.id}">View</button>
        </td>
    ` : `
        <td>
            <div class="company-info">
                <div class="company-avatar">${initials}</div>
                <div class="company-details">
                    <div class="company-name" data-company-id="${lead.id}">${escapeHtml(lead.name)}</div>
                    <div class="company-meta">${escapeHtml(lead.country || 'Unknown')}</div>
                </div>
            </div>
        </td>
        <td>
            <span class="score-badge tier-${tierClass}">
                ${lead.overall_score?.toFixed(0) || 0} - Tier ${lead.priority_tier || '-'}
            </span>
        </td>
        <td>${lead.phase1_count > 0 ? 'Phase 1' : 'Pre-clinical'}</td>
        <td>
            <div class="molecule-pills">
                ${lead.molecule_count > 0 ? `<span class="molecule-pill">${lead.molecule_count} molecules</span>` : '-'}
            </div>
        </td>
        <td>${lead.total_funding ? '$' + (lead.total_funding / 1000000).toFixed(1) + 'M' : '-'}</td>
        <td>${escapeHtml(lead.employee_band || 'Unknown')}</td>
        <td>
            <span class="status-badge ${statusClass}">
                ${statusText}
            </span>
        </td>
        <td>
            <button class="btn-action view-company" data-company-id="${lead.id}">View</button>
        </td>
    `;
    
    return `<tr>${cols}</tr>`;
}

function updatePagination(page, pageSize, total) {
    const container = document.getElementById('paginationContainer');
    if (!container) return;

    const totalPages = Math.ceil(total / pageSize);
    const start = ((page - 1) * pageSize) + 1;
    const end = Math.min(page * pageSize, total);

    container.innerHTML = `
        <div class="pagination-info">
            Showing ${start} to ${end} of ${total} results
        </div>
        <div class="pagination-controls">
            <button class="page-btn" id="prevPage" ${page === 1 ? 'disabled' : ''}>Previous</button>
            ${Array.from({length: Math.min(5, totalPages)}, (_, i) => {
                const pageNum = i + 1;
                return `<button class="page-btn ${pageNum === page ? 'active' : ''}" onclick="goToPage(${pageNum})">${pageNum}</button>`;
            }).join('')}
            <button class="page-btn" id="nextPage" ${page >= totalPages ? 'disabled' : ''}>Next</button>
        </div>
    `;

    // Re-attach pagination listeners
    const prevBtn = document.getElementById('prevPage');
    const nextBtn = document.getElementById('nextPage');
    
    if (prevBtn) {
        prevBtn.onclick = () => {
            if (currentPage > 1) {
                currentPage--;
                loadCurrentView();
            }
        };
    }
    
    if (nextBtn) {
        nextBtn.onclick = () => {
            if (currentPage < totalPages) {
                currentPage++;
                loadCurrentView();
            }
        };
    }
}

function goToPage(page) {
    currentPage = page;
    loadCurrentView();
}

function setupDashboardEventListeners() {
    // Filter listeners
    const filterTier = document.getElementById('filterTier');
    if (filterTier) {
        filterTier.value = currentFilters.priorityTier || '';
        filterTier.addEventListener('change', function(e) {
            currentFilters.priorityTier = e.target.value;
            loadLeads();
        });
    }

    const excludeStale = document.getElementById('excludeStale');
    if (excludeStale) {
        excludeStale.addEventListener('click', function() {
            currentFilters.excludeStale = !currentFilters.excludeStale;
            this.querySelector('span').textContent = currentFilters.excludeStale ? '✓' : '';
            loadLeads();
        });
    }

    const exportBtn = document.getElementById('exportLeads');
    if (exportBtn) {
        exportBtn.addEventListener('click', () => exportLeads());
    }
}

// Company Details Panel
async function openCompanyDetails(companyId) {
    try {
        const response = await fetch(`${API_BASE}/leads/${companyId}`);
        if (!response.ok) throw new Error('Failed to fetch company details');
        
        const data = await response.json();
        const panel = document.getElementById('detailsPanel');
        const panelContent = document.getElementById('panelContent');
        
        document.getElementById('panelTitle').textContent = data.company.name;
        panelContent.innerHTML = createCompanyDetailsHTML(data);
        panel.classList.add('open');
        
    } catch (error) {
        console.error('Error loading company details:', error);
        showError('Failed to load company details');
    }
}

function createCompanyDetailsHTML(data) {
    return `
        <div class="panel-section">
            <h3 class="panel-section-title">Company Overview</h3>
            <div class="info-grid">
                <div class="info-item">
                    <span class="info-label">Overall Score</span>
                    <span class="info-value">${data.score?.overall_score?.toFixed(0) || 0}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Priority Tier</span>
                    <span class="info-value">Tier ${data.score?.priority_tier || '-'}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Employees</span>
                    <span class="info-value">${escapeHtml(data.company.employee_band || 'Unknown')}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Needs CDMO</span>
                    <span class="info-value">${data.score?.needs_cdmo ? '✅ Yes' : '❌ No'}</span>
                </div>
            </div>
        </div>

        <div class="panel-section">
            <h3 class="panel-section-title">Score Breakdown</h3>
            <div class="info-grid">
                <div class="info-item">
                    <span class="info-label">Phase 1 Readiness</span>
                    <span class="info-value">${data.score?.phase1_readiness_score?.toFixed(0) || 0}/30</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Funding Score</span>
                    <span class="info-value">${data.score?.funding_score?.toFixed(0) || 0}/25</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Outsourcing Likelihood</span>
                    <span class="info-value">${data.score?.outsourcing_likelihood_score?.toFixed(0) || 0}/25</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Molecule Quality</span>
                    <span class="info-value">${data.score?.molecule_quality_score?.toFixed(0) || 0}/10</span>
                </div>
            </div>
        </div>

        <div class="panel-section">
            <h3 class="panel-section-title">Molecules (${data.molecules.length})</h3>
            ${data.molecules.length > 0 ? data.molecules.map(mol => `
                <div class="info-item" style="margin-bottom: 12px; padding: 8px; border: 1px solid var(--gray-200); border-radius: 6px;">
                    <span class="info-label">${escapeHtml(mol.name)}</span>
                    <span class="info-value">
                        ${escapeHtml(mol.indication || 'Unknown indication')}<br>
                        <small>Stage: ${escapeHtml(mol.development_stage || 'Unknown')}</small>
                        ${mol.pubchem_cid ? `<br><small><a href="https://pubchem.ncbi.nlm.nih.gov/compound/${mol.pubchem_cid}" target="_blank">PubChem →</a></small>` : ''}
                    </span>
                </div>
            `).join('') : '<p style="color: var(--gray-500);">No molecules recorded</p>'}
        </div>

        <div class="panel-section">
            <h3 class="panel-section-title">Clinical Trials (${data.trials.length})</h3>
            ${data.trials.length > 0 ? data.trials.slice(0, 5).map(trial => `
                <div class="info-item" style="margin-bottom: 12px;">
                    <span class="info-label">${escapeHtml(trial.trial_id)}</span>
                    <span class="info-value">
                        ${escapeHtml(trial.phase)} - ${escapeHtml(trial.status)}<br>
                        <small>Started: ${trial.start_date ? new Date(trial.start_date).toLocaleDateString() : 'N/A'}</small>
                    </span>
                </div>
            `).join('') : '<p style="color: var(--gray-500);">No trials recorded</p>'}
        </div>

        <div class="panel-section">
            <h3 class="panel-section-title">Funding History</h3>
            ${data.funding.length > 0 ? data.funding.slice(0, 5).map(round => `
                <div class="info-item" style="margin-bottom: 12px;">
                    <span class="info-label">${escapeHtml(round.round_type)}</span>
                    <span class="info-value">
                        $${round.amount_usd ? (round.amount_usd / 1000000).toFixed(1) + 'M' : 'Undisclosed'}<br>
                        <small>${new Date(round.date).toLocaleDateString()}</small>
                    </span>
                </div>
            `).join('') : '<p style="color: var(--gray-500);">No funding recorded</p>'}
        </div>

        <div class="panel-section">
            <h3 class="panel-section-title">Key Contacts (${data.contacts.length})</h3>
            <div class="contact-list">
                ${data.contacts.length > 0 ? data.contacts.map(contact => createContactHTML(contact)).join('') : 
                '<p style="color: var(--gray-500);">No contacts found</p>'}
            </div>
            ${data.contacts.length === 0 ? `
                <button class="btn-action btn-primary discover-contacts" data-company-id="${data.company.id}" style="width: 100%; margin-top: 12px;">
                    Discover Contacts
                </button>
            ` : ''}
        </div>
    `;
}

function createContactHTML(contact) {
    const initials = getInitials(contact.name);
    return `
        <div class="contact-item">
            <div class="contact-avatar">${initials}</div>
            <div class="contact-info">
                <div class="contact-name">${escapeHtml(contact.name)}</div>
                <div class="contact-title">${escapeHtml(contact.title)}</div>
            </div>
            <div class="contact-actions">
                ${contact.email ? `<a class="contact-action" href="mailto:${contact.email}" title="Email">✉</a>` : ''}
                ${contact.linkedin_url ? `<a class="contact-action" href="${contact.linkedin_url}" target="_blank" title="LinkedIn">in</a>` : ''}
            </div>
        </div>
    `;
}

function closeDetailsPanel() {
    const panel = document.getElementById('detailsPanel');
    if (panel) panel.classList.remove('open');
}

// Export functionality
function exportLeads() {
    window.location.href = `${API_BASE}/export/leads`;
}

// Utility functions
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

function getInitials(name) {
    if (!name) return '?';
    const parts = name.split(' ');
    if (parts.length >= 2) {
        return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
    }
    return name.substring(0, 2).toUpperCase();
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function updateMetric(id, value) {
    const element = document.getElementById(id);
    if (element) element.textContent = (value || 0).toLocaleString();
}

function updateText(id, text) {
    const element = document.getElementById(id);
    if (element) element.textContent = text;
}

function showError(message) {
    const toast = document.createElement('div');
    toast.style.cssText = `
        position: fixed; bottom: 20px; right: 20px; background: #ef4444; color: white;
        padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        z-index: 10000; animation: slideIn 0.3s ease;
    `;
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 5000);
}

function showSuccess(message) {
    const toast = document.createElement('div');
    toast.style.cssText = `
        position: fixed; bottom: 20px; right: 20px; background: #10b981; color: white;
        padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        z-index: 10000; animation: slideIn 0.3s ease;
    `;
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}

function showComingSoon() {
    const contentArea = document.getElementById('contentArea');
    if (contentArea) {
        contentArea.innerHTML = `
            <div class="empty-state" style="padding: 100px;">
                <div class="empty-icon">🚀</div>
                <div class="empty-title">Coming Soon</div>
                <div class="empty-text">This feature is under development</div>
            </div>
        `;
    }
}

// Auto refresh
function startAutoRefresh() {
    setInterval(() => {
        if (currentView === 'dashboard') {
            loadDashboard();
        }
    }, 60000); // Refresh every minute
}

// Event delegation for dynamic elements
document.addEventListener('click', function(e) {
    // Company name click
    if (e.target.classList.contains('company-name')) {
        const companyId = e.target.dataset.companyId;
        if (companyId) openCompanyDetails(companyId);
    }
    
    // View button click
    if (e.target.classList.contains('view-company')) {
        const companyId = e.target.dataset.companyId;
        if (companyId) openCompanyDetails(companyId);
    }
    
    // Discover contacts button
    if (e.target.classList.contains('discover-contacts')) {
        const companyId = e.target.dataset.companyId;
        if (companyId) discoverContacts(companyId);
    }
    
    // Add funding button
    if (e.target.id === 'addFunding') {
        showAddFundingModal();
    }
    
    // Add signal button
    if (e.target.id === 'addSignal') {
        showAddSignalModal();
    }
    
    // Rescore all button
    if (e.target.id === 'rescoreAll') {
        rescoreAllCompanies();
    }
    
    // Enrich molecules button
    if (e.target.id === 'enrichMolecules') {
        enrichMoleculesFromPubChem();
    }
    
    // Fetch new trials button
    if (e.target.id === 'fetchNewTrials') {
        fetchNewTrials();
    }
    
    // Search patents button
    if (e.target.id === 'searchPatents') {
        searchNewPatents();
    }
    
    // Discover more contacts button
    if (e.target.id === 'discoverMoreContacts') {
        discoverAllContacts();
    }
});

// Additional functionality for specific actions
async function discoverContacts(companyId) {
    try {
        showSuccess('Discovering contacts... This may take a moment.');
        const response = await fetch(`${API_BASE}/contacts/discover/${companyId}`, {
            method: 'POST'
        });
        
        if (!response.ok) throw new Error('Failed to discover contacts');
        const result = await response.json();
        
        if (result.success) {
            showSuccess(`Found ${result.added} new contacts!`);
            await openCompanyDetails(companyId); // Refresh panel
        } else {
            showError('No contacts found. API keys may not be configured.');
        }
    } catch (error) {
        console.error('Error discovering contacts:', error);
        showError('Failed to discover contacts');
    }
}

async function rescoreAllCompanies() {
    try {
        const btn = document.getElementById('rescoreAll');
        if (btn) {
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner" style="width: 14px; height: 14px;"></span> Rescoring...';
        }
        
        const response = await fetch(`${API_BASE}/rescore`, { method: 'POST' });
        if (!response.ok) throw new Error('Failed to rescore');
        
        const result = await response.json();
        showSuccess(`Rescored ${result.rescored} companies successfully!`);
        
        // Reload current view
        await loadCurrentView();
        
    } catch (error) {
        console.error('Error rescoring:', error);
        showError('Failed to rescore companies');
    } finally {
        const btn = document.getElementById('rescoreAll');
        if (btn) {
            btn.disabled = false;
            btn.innerHTML = '<span>🎯</span> Rescore All';
        }
    }
}

async function enrichMoleculesFromPubChem() {
    try {
        const btn = document.getElementById('enrichMolecules');
        if (btn) {
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner" style="width: 14px; height: 14px;"></span> Enriching...';
        }
        
        const response = await fetch(`${API_BASE}/enrich/molecules`, { method: 'POST' });
        if (!response.ok) throw new Error('Failed to enrich molecules');
        
        const result = await response.json();
        showSuccess(`Enriched ${result.enriched} molecules from PubChem!`);
        
        // Reload molecules view
        await loadMolecules();
        
    } catch (error) {
        console.error('Error enriching molecules:', error);
        showError('Failed to enrich molecules');
    } finally {
        const btn = document.getElementById('enrichMolecules');
        if (btn) {
            btn.disabled = false;
            btn.innerHTML = '<span>🧬</span> Enrich from PubChem';
        }
    }
}

async function fetchNewTrials() {
    try {
        const btn = document.getElementById('fetchNewTrials');
        if (btn) {
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner" style="width: 14px; height: 14px;"></span> Fetching...';
        }
        
        const response = await fetch(`${API_BASE}/ingest/clinical-trials`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ sinceDays: 30, maxResults: 100 })
        });
        
        if (!response.ok) throw new Error('Failed to fetch trials');
        
        const result = await response.json();
        showSuccess(`Found ${result.trialsAdded} new trials!`);
        
        // Reload trials view
        await loadTrials();
        
    } catch (error) {
        console.error('Error fetching trials:', error);
        showError('Failed to fetch new trials');
    } finally {
        const btn = document.getElementById('fetchNewTrials');
        if (btn) {
            btn.disabled = false;
            btn.innerHTML = '<span>🔄</span> Fetch New Trials';
        }
    }
}

async function searchNewPatents() {
    try {
        const btn = document.getElementById('searchPatents');
        if (btn) {
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner" style="width: 14px; height: 14px;"></span> Searching...';
        }
        
        const response = await fetch(`${API_BASE}/ingest/patents`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ sinceDays: 90 })
        });
        
        if (!response.ok) throw new Error('Failed to search patents');
        
        const result = await response.json();
        showSuccess(`Found ${result.patentsAdded} new patents!`);
        
        // Reload patents view
        await loadPatents();
        
    } catch (error) {
        console.error('Error searching patents:', error);
        showError('Failed to search patents');
    } finally {
        const btn = document.getElementById('searchPatents');
        if (btn) {
            btn.disabled = false;
            btn.innerHTML = '<span>🔍</span> Search Patents';
        }
    }
}

async function discoverAllContacts() {
    try {
        const btn = document.getElementById('discoverMoreContacts');
        if (btn) {
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner" style="width: 14px; height: 14px;"></span> Discovering...';
        }
        
        showSuccess('Discovering contacts for top companies... This may take several minutes.');
        
        // Get top companies without contacts
        const response = await fetch(`${API_BASE}/leads?pageSize=10&priorityTier=A`);
        if (!response.ok) throw new Error('Failed to fetch companies');
        
        const data = await response.json();
        let totalFound = 0;
        
        for (const company of data.leads) {
            try {
                const contactResponse = await fetch(`${API_BASE}/contacts/discover/${company.id}`, {
                    method: 'POST'
                });
                if (contactResponse.ok) {
                    const result = await contactResponse.json();
                    totalFound += result.added || 0;
                }
                // Rate limiting
                await new Promise(resolve => setTimeout(resolve, 2000));
            } catch (err) {
                console.error(`Failed for company ${company.name}:`, err);
            }
        }
        
        showSuccess(`Discovery complete! Found ${totalFound} new contacts.`);
        await loadContacts();
        
    } catch (error) {
        console.error('Error discovering contacts:', error);
        showError('Failed to discover contacts');
    } finally {
        const btn = document.getElementById('discoverMoreContacts');
        if (btn) {
            btn.disabled = false;
            btn.innerHTML = '<span>🔍</span> Discover Contacts';
        }
    }
}

// Modal functions
function showAddFundingModal() {
    const modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.style.cssText = `
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.5); display: flex; align-items: center;
        justify-content: center; z-index: 10000;
    `;
    
    modal.innerHTML = `
        <div class="modal-content" style="background: white; padding: 32px; border-radius: 12px; width: 480px; max-width: 90%;">
            <h2 style="margin-bottom: 24px; font-size: 20px; font-weight: 600;">Add Funding Round</h2>
            <form id="addFundingForm">
                <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 4px; font-size: 13px; font-weight: 500; color: #6b7280;">Company Name</label>
                    <input type="text" name="companyName" required style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px;">
                </div>
                <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 4px; font-size: 13px; font-weight: 500; color: #6b7280;">Round Type</label>
                    <select name="roundType" required style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px;">
                        <option value="Seed">Seed</option>
                        <option value="Series A">Series A</option>
                        <option value="Series B">Series B</option>
                        <option value="Series C">Series C</option>
                        <option value="Grant">Grant</option>
                    </select>
                </div>
                <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 4px; font-size: 13px; font-weight: 500; color: #6b7280;">Amount (USD)</label>
                    <input type="number" name="amountUsd" min="0" step="100000" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px;">
                </div>
                <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 4px; font-size: 13px; font-weight: 500; color: #6b7280;">Date</label>
                    <input type="date" name="date" required style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px;">
                </div>
                <div style="margin-bottom: 24px;">
                    <label style="display: block; margin-bottom: 4px; font-size: 13px; font-weight: 500; color: #6b7280;">Lead Investor</label>
                    <input type="text" name="leadInvestor" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px;">
                </div>
                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                    <button type="button" onclick="this.closest('.modal-overlay').remove()" style="padding: 8px 16px; border: 1px solid #d1d5db; border-radius: 6px; background: white;">Cancel</button>
                    <button type="submit" style="padding: 8px 16px; border: none; border-radius: 6px; background: #2563eb; color: white;">Add Funding</button>
                </div>
            </form>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    document.getElementById('addFundingForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const formData = new FormData(e.target);
        
        try {
            const response = await fetch(`${API_BASE}/funding`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    companyName: formData.get('companyName'),
                    roundType: formData.get('roundType'),
                    amountUsd: parseFloat(formData.get('amountUsd')),
                    date: formData.get('date'),
                    leadInvestor: formData.get('leadInvestor')
                })
            });
            
            if (!response.ok) throw new Error('Failed to add funding');
            
            showSuccess('Funding round added successfully!');
            modal.remove();
            await loadFunding();
            
        } catch (error) {
            showError('Failed to add funding round');
        }
    });
}

function showAddSignalModal() {
    const modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.style.cssText = `
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.5); display: flex; align-items: center;
        justify-content: center; z-index: 10000;
    `;
    
    modal.innerHTML = `
        <div class="modal-content" style="background: white; padding: 32px; border-radius: 12px; width: 480px; max-width: 90%;">
            <h2 style="margin-bottom: 24px; font-size: 20px; font-weight: 600;">Add Market Signal</h2>
            <form id="addSignalForm">
                <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 4px; font-size: 13px; font-weight: 500; color: #6b7280;">Company Name</label>
                    <input type="text" name="companyName" required style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px;">
                </div>
                <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 4px; font-size: 13px; font-weight: 500; color: #6b7280;">Signal Type</label>
                    <select name="signalType" required style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px;">
                        <option value="ind">IND Signal</option>
                        <option value="clinical_trial">Clinical Trial</option>
                        <option value="patent">Patent</option>
                        <option value="funding">Funding</option>
                        <option value="hiring">Hiring</option>
                        <option value="conference">Conference</option>
                        <option value="press">Press</option>
                        <option value="cdmo">CDMO</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 4px; font-size: 13px; font-weight: 500; color: #6b7280;">Signal Strength</label>
                    <select name="signalStrength" required style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px;">
                        <option value="strong">Strong</option>
                        <option value="medium">Medium</option>
                        <option value="weak">Weak</option>
                    </select>
                </div>
                <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 4px; font-size: 13px; font-weight: 500; color: #6b7280;">Title</label>
                    <input type="text" name="title" required style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px;">
                </div>
                <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 4px; font-size: 13px; font-weight: 500; color: #6b7280;">Source</label>
                    <input type="text" name="source" required style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px;">
                </div>
                <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 4px; font-size: 13px; font-weight: 500; color: #6b7280;">URL</label>
                    <input type="url" name="url" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px;">
                </div>
                <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 4px; font-size: 13px; font-weight: 500; color: #6b7280;">Date</label>
                    <input type="date" name="date" required style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px;">
                </div>
                <div style="margin-bottom: 24px;">
                    <label style="display: block; margin-bottom: 4px; font-size: 13px; font-weight: 500; color: #6b7280;">Notes</label>
                    <textarea name="content" rows="3" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px;"></textarea>
                </div>
                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                    <button type="button" onclick="this.closest('.modal-overlay').remove()" style="padding: 8px 16px; border: 1px solid #d1d5db; border-radius: 6px; background: white;">Cancel</button>
                    <button type="submit" style="padding: 8px 16px; border: none; border-radius: 6px; background: #2563eb; color: white;">Add Signal</button>
                </div>
            </form>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    document.getElementById('addSignalForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const formData = new FormData(e.target);
        
        try {
            const response = await fetch(`${API_BASE}/signals`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    companyName: formData.get('companyName'),
                    signalType: formData.get('signalType'),
                    signalStrength: formData.get('signalStrength'),
                    title: formData.get('title'),
                    source: formData.get('source'),
                    url: formData.get('url'),
                    date: formData.get('date'),
                    content: formData.get('content'),
                    relevanceScore: 0.7
                })
            });
            
            if (!response.ok) throw new Error('Failed to add signal');
            
            showSuccess('Signal added successfully!');
            modal.remove();
            await loadSignals();
            
        } catch (error) {
            showError('Failed to add signal');
        }
    });
}

// Add CSS animation for toasts
const style = document.createElement('style');
style.textContent = `
    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    
    .modal-overlay {
        animation: fadeIn 0.2s ease;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    
    .spinner {
        display: inline-block;
        border: 2px solid rgba(0,0,0,0.1);
        border-top-color: currentColor;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }
    
    .filter-input {
        padding: 6px 12px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 13px;
    }
    
    .filter-input:focus {
        outline: none;
        border-color: #2563eb;
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }
`;
document.head.appendChild(style);


// ============= DISCOVERY VIEW =============
async function loadDiscoveryView() {
    const contentArea = document.getElementById('contentArea');
    
    contentArea.innerHTML = `
        <div id="discoveryView">
            <h1 class="page-title">Pre-Phase 1 Discovery</h1>
            <p class="page-subtitle">Early-stage companies and molecules before clinical entry</p>

            <!-- Discovery Metrics -->
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-label">New Compounds</div>
                    <div class="metric-value" id="newCompoundsCount">-</div>
                    <div class="metric-change positive">
                        <span>↑</span>
                        <span id="compoundsChange">This week</span>
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Early Patents</div>
                    <div class="metric-value" id="earlyPatentsCount">-</div>
                    <div class="metric-change positive">
                        <span>↑</span>
                        <span id="patentsChange">Last 30 days</span>
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Active Grants</div>
                    <div class="metric-value" id="grantsCount">-</div>
                    <div class="metric-change positive">
                        <span>↑</span>
                        <span id="grantsChange">NIH/EU/UK</span>
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Publications</div>
                    <div class="metric-value" id="publicationsCount">-</div>
                    <div class="metric-change positive">
                        <span>↑</span>
                        <span id="pubsChange">Research signals</span>
                    </div>
                </div>
            </div>

            <!-- Discovery Actions -->
            <div class="filter-bar">
                <button class="btn-action btn-primary" id="runPubChemDiscovery">
                    <span>🧬</span>
                    Scan PubChem
                </button>
                <button class="btn-action btn-primary" id="runPatentDiscovery">
                    <span>📋</span>
                    Search Patents
                </button>
                <button class="btn-action btn-primary" id="runGrantDiscovery">
                    <span>💵</span>
                    Check Grants
                </button>
                <button class="btn-action btn-primary" id="runPublicationDiscovery">
                    <span>📚</span>
                    Scan Publications
                </button>
                <button class="btn-action btn-primary" id="runPressDiscovery">
                    <span>📰</span>
                    Check News
                </button>
                <button class="btn-action" id="runFullDiscovery" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white;">
                    <span>🚀</span>
                    Run Full Discovery
                </button>
            </div>

            <!-- Discovery Results Tabs -->
            <div class="discovery-tabs" style="margin-top: 24px; margin-bottom: 16px;">
                <button class="tab-btn active" data-tab="recent-signals">Recent Signals</button>
                <button class="tab-btn" data-tab="compounds">Compounds</button>
                <button class="tab-btn" data-tab="companies">Companies</button>
                <button class="tab-btn" data-tab="timeline">Timeline</button>
            </div>

            <!-- Tab Content -->
            <div class="data-table-container">
                <div id="recent-signals-content" class="tab-content active">
                    <div class="table-header">
                        <h3 class="table-title">Latest Discovery Signals</h3>
                        <div class="table-actions">
                            <span class="filter-badge" id="filterStrong">
                                Strong Signals Only
                                <span></span>
                            </span>
                        </div>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Company</th>
                                <th>Signal Type</th>
                                <th>Source</th>
                                <th>Description</th>
                                <th>Strength</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="discoverySignalsBody">
                            <tr><td colspan="7" class="loading"><div class="spinner"></div></td></tr>
                        </tbody>
                    </table>
                </div>

                <div id="compounds-content" class="tab-content" style="display: none;">
                    <div class="table-header">
                        <h3 class="table-title">Pre-Clinical Compounds</h3>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Substance ID</th>
                                <th>Depositor</th>
                                <th>Company</th>
                                <th>Submission Date</th>
                                <th>PubChem CID</th>
                                <th>Stage</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="compoundsTableBody">
                            <tr><td colspan="7" class="loading"><div class="spinner"></div></td></tr>
                        </tbody>
                    </table>
                </div>

                <div id="companies-content" class="tab-content" style="display: none;">
                    <div class="table-header">
                        <h3 class="table-title">Pre-Phase 1 Companies</h3>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Company</th>
                                <th>Total Signals</th>
                                <th>Compounds</th>
                                <th>Patents</th>
                                <th>Grants</th>
                                <th>Latest Activity</th>
                                <th>Pre-Phase 1 Score</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="prePhase1CompaniesBody">
                            <tr><td colspan="8" class="loading"><div class="spinner"></div></td></tr>
                        </tbody>
                    </table>
                </div>

                <div id="timeline-content" class="tab-content" style="display: none;">
                    <div class="timeline-container" id="discoveryTimeline">
                        <!-- Timeline will be rendered here -->
                    </div>
                </div>

                <div class="pagination" id="discoveryPagination"></div>
            </div>
        </div>
    `;

    // Add tab switching
    setupDiscoveryTabs();
    
    // Load initial data
    await loadDiscoveryStats();
    await loadDiscoverySignals();
    
    // Setup discovery action buttons
    setupDiscoveryActions();
}

// ============= COMPOUNDS VIEW =============
async function loadEarlyCompoundsView() {
    const contentArea = document.getElementById('contentArea');
    
    contentArea.innerHTML = `
        <div id="compoundsView">
            <h1 class="page-title">Early-Stage Compounds</h1>
            <p class="page-subtitle">Track compounds from PubChem, patents, and publications</p>

            <div class="filter-bar">
                <div class="filter-group">
                    <span class="filter-label">Source:</span>
                    <select class="filter-select" id="compoundSourceFilter">
                        <option value="">All Sources</option>
                        <option value="PubChem">PubChem</option>
                        <option value="Patent">Patent</option>
                        <option value="Publication">Publication</option>
                    </select>
                </div>
                <div class="filter-group">
                    <span class="filter-label">Date Range:</span>
                    <select class="filter-select" id="compoundDateFilter">
                        <option value="7">Last 7 days</option>
                        <option value="30">Last 30 days</option>
                        <option value="90">Last 90 days</option>
                    </select>
                </div>
                <button class="btn-action btn-primary" id="enrichCompounds">
                    <span>🔬</span>
                    Enrich Structures
                </button>
            </div>

            <div class="data-table-container">
                <div class="table-header">
                    <h3 class="table-title">Compound Database</h3>
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Company/Depositor</th>
                            <th>Source</th>
                            <th>Date</th>
                            <th>Structure</th>
                            <th>Stage</th>
                            <th>Related Patents</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="earlyCompoundsTableBody">
                        <tr><td colspan="8" class="loading"><div class="spinner"></div></td></tr>
                    </tbody>
                </table>
                <div class="pagination" id="compoundsPagination"></div>
            </div>
        </div>
    `;

    await loadEarlyCompounds();
}

// ============= GRANTS VIEW =============
async function loadGrantsView() {
    const contentArea = document.getElementById('contentArea');
    
    contentArea.innerHTML = `
        <div id="grantsView">
            <h1 class="page-title">Grant Tracking</h1>
            <p class="page-subtitle">NIH, EU Horizon, UK Research grants for drug discovery</p>

            <div class="metrics-grid" style="margin-bottom: 24px;">
                <div class="metric-card">
                    <div class="metric-label">Total Tracked</div>
                    <div class="metric-value" id="totalGrants">0</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">NIH Grants</div>
                    <div class="metric-value" id="nihGrants">0</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Total Funding</div>
                    <div class="metric-value" id="totalGrantFunding">$0</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">SBIR/STTR</div>
                    <div class="metric-value" id="sbirGrants">0</div>
                </div>
            </div>

            <div class="data-table-container">
                <div class="table-header">
                    <h3 class="table-title">Active Grants</h3>
                    <div class="table-actions">
                        <button class="btn-action btn-primary" id="fetchNewGrants">
                            <span>🔄</span>
                            Update Grants
                        </button>
                    </div>
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Grant ID</th>
                            <th>Company/Institution</th>
                            <th>Title</th>
                            <th>Agency</th>
                            <th>Amount</th>
                            <th>Start Date</th>
                            <th>PI</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="grantsTableBody">
                        <tr><td colspan="8" class="loading"><div class="spinner"></div></td></tr>
                    </tbody>
                </table>
                <div class="pagination" id="grantsPagination"></div>
            </div>
        </div>
    `;

    await loadGrants();
}

// ============= DATA LOADING FUNCTIONS =============

async function loadDiscoveryStats() {
    try {
        const response = await fetch(`${API_BASE}/discovery/stats`);
        if (!response.ok) throw new Error('Failed to fetch discovery stats');
        
        const stats = await response.json();
        
        updateText('newCompoundsCount', stats.preclinicalCompounds || 0);
        updateText('earlyPatentsCount', stats.patents || 0);
        updateText('grantsCount', stats.grants || 0);
        updateText('publicationsCount', stats.publications || 0);
        updateText('discoveryCount', stats.recentSignals || 0);
        
    } catch (error) {
        console.error('Error loading discovery stats:', error);
    }
}

async function loadDiscoverySignals() {
    try {
        // Get all recent signals with pre-phase 1 types
        const response = await fetch(`${API_BASE}/leads?pageSize=100`);
        if (!response.ok) throw new Error('Failed to fetch data');
        
        const data = await response.json();
        const tbody = document.getElementById('discoverySignalsBody');
        if (!tbody) return;

        // Collect all pre-phase 1 signals
        const signals = [];
        for (const company of data.leads.slice(0, 20)) {
            const detailResponse = await fetch(`${API_BASE}/leads/${company.id}`);
            if (detailResponse.ok) {
                const details = await detailResponse.json();
                const prePhase1Signals = details.signals.filter(s => 
                    ['new_compound', 'early_patent', 'grant', 'publication', 'press', 'sec_filing'].includes(s.signal_type)
                );
                
                prePhase1Signals.forEach(signal => {
                    signals.push({ ...signal, companyName: company.name, companyId: company.id });
                });
            }
        }

        if (signals.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="7">
                        <div class="empty-state">
                            <div class="empty-icon">🔍</div>
                            <div class="empty-title">No discovery signals yet</div>
                            <div class="empty-text">Run discovery to find pre-Phase 1 opportunities</div>
                        </div>
                    </td>
                </tr>
            `;
            return;
        }

        // Sort by date
        signals.sort((a, b) => new Date(b.date) - new Date(a.date));

        tbody.innerHTML = signals.slice(0, 50).map(signal => {
            const typeColors = {
                'new_compound': '#8b5cf6',
                'early_patent': '#3b82f6',
                'grant': '#10b981',
                'publication': '#f59e0b',
                'press': '#ef4444',
                'sec_filing': '#06b6d4'
            };
            
            return `
                <tr>
                    <td>${new Date(signal.date).toLocaleDateString()}</td>
                    <td>
                        <div class="company-name" data-company-id="${signal.companyId}">
                            <strong>${escapeHtml(signal.companyName)}</strong>
                        </div>
                    </td>
                    <td>
                        <span class="molecule-pill" style="background: ${typeColors[signal.signal_type]}20; color: ${typeColors[signal.signal_type]};">
                            ${escapeHtml(signal.signal_type.replace('_', ' '))}
                        </span>
                    </td>
                    <td>${escapeHtml(signal.source)}</td>
                    <td>${escapeHtml(signal.title || signal.content || '-')}</td>
                    <td>
                        <span class="status-badge ${signal.signal_strength}">
                            ${escapeHtml(signal.signal_strength || 'medium')}
                        </span>
                    </td>
                    <td>
                        <button class="btn-action view-company" data-company-id="${signal.companyId}">View</button>
                    </td>
                </tr>
            `;
        }).join('');
        
    } catch (error) {
        console.error('Error loading discovery signals:', error);
    }
}

async function loadEarlyCompounds() {
    try {
        const response = await fetch(`${API_BASE}/discovery/compounds`);
        if (!response.ok) {
            // Fallback to mock data for demonstration
            const tbody = document.getElementById('earlyCompoundsTableBody');
            if (tbody) {
                tbody.innerHTML = `
                    <tr>
                        <td>SID123456</td>
                        <td>BioTech Inc.</td>
                        <td>PubChem</td>
                        <td>${new Date().toLocaleDateString()}</td>
                        <td><a href="#" target="_blank">View</a></td>
                        <td><span class="status-badge active">Discovery</span></td>
                        <td>2 patents</td>
                        <td><button class="btn-action">Details</button></td>
                    </tr>
                `;
            }
            return;
        }
        
        const compounds = await response.json();
        const tbody = document.getElementById('earlyCompoundsTableBody');
        if (!tbody) return;

        tbody.innerHTML = compounds.map(compound => `
            <tr>
                <td><strong>${escapeHtml(compound.substance_id)}</strong></td>
                <td>${escapeHtml(compound.depositor_name)}</td>
                <td>${escapeHtml(compound.companyName || '-')}</td>
                <td>${new Date(compound.submission_date).toLocaleDateString()}</td>
                <td>${compound.compound_cid ? `<a href="https://pubchem.ncbi.nlm.nih.gov/compound/${compound.compound_cid}" target="_blank">CID: ${compound.compound_cid}</a>` : '-'}</td>
                <td><span class="status-badge active">${escapeHtml(compound.stage)}</span></td>
                <td><button class="btn-action">View</button></td>
            </tr>
        `).join('');
        
    } catch (error) {
        console.error('Error loading compounds:', error);
    }
}

async function loadGrants() {
    try {
        const response = await fetch(`${API_BASE}/discovery/grants/list`);
        if (!response.ok) {
            // Fallback for demonstration
            const tbody = document.getElementById('grantsTableBody');
            if (tbody) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8">
                            <div class="empty-state">
                                <div class="empty-icon">💵</div>
                                <div class="empty-title">No grants tracked</div>
                                <div class="empty-text">Grant data will appear here after discovery</div>
                            </div>
                        </td>
                    </tr>
                `;
            }
            return;
        }
        
        const grants = await response.json();
        // Render grants table
        
    } catch (error) {
        console.error('Error loading grants:', error);
    }
}

// ============= DISCOVERY ACTIONS =============

function setupDiscoveryActions() {
    // PubChem Discovery
    const pubchemBtn = document.getElementById('runPubChemDiscovery');
    if (pubchemBtn) {
        pubchemBtn.addEventListener('click', async () => {
            pubchemBtn.disabled = true;
            pubchemBtn.innerHTML = '<span class="spinner" style="width: 14px; height: 14px;"></span> Scanning...';
            
            try {
                const response = await fetch(`${API_BASE}/discovery/pubchem`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ days: 7, limit: 10 })
                });
                
                if (!response.ok) throw new Error('Discovery failed');
                
                const result = await response.json();
                showSuccess(`Found ${result.discovered} new PubChem compounds!`);
                await loadDiscoverySignals();
                
            } catch (error) {
                showError('PubChem discovery failed');
            } finally {
                pubchemBtn.disabled = false;
                pubchemBtn.innerHTML = '<span>🧬</span> Scan PubChem';
            }
        });
    }

    // Patent Discovery
    const patentBtn = document.getElementById('runPatentDiscovery');
    if (patentBtn) {
        patentBtn.addEventListener('click', async () => {
            patentBtn.disabled = true;
            patentBtn.innerHTML = '<span class="spinner" style="width: 14px; height: 14px;"></span> Searching...';
            
            try {
                const response = await fetch(`${API_BASE}/discovery/patents`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ days: 30 })
                });
                
                if (!response.ok) throw new Error('Discovery failed');
                
                const result = await response.json();
                showSuccess(`Found ${result.discovered} early-stage patents!`);
                await loadDiscoverySignals();
                
            } catch (error) {
                showError('Patent discovery failed');
            } finally {
                patentBtn.disabled = false;
                patentBtn.innerHTML = '<span>📋</span> Search Patents';
            }
        });
    }

    // Grant Discovery
    const grantBtn = document.getElementById('runGrantDiscovery');
    if (grantBtn) {
        grantBtn.addEventListener('click', async () => {
            grantBtn.disabled = true;
            grantBtn.innerHTML = '<span class="spinner" style="width: 14px; height: 14px;"></span> Checking...';
            
            try {
                const response = await fetch(`${API_BASE}/discovery/grants`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ fiscalYear: new Date().getFullYear() })
                });
                
                if (!response.ok) throw new Error('Discovery failed');
                
                const result = await response.json();
                showSuccess(`Found ${result.discovered} relevant grants!`);
                await loadDiscoverySignals();
                
            } catch (error) {
                showError('Grant discovery failed');
            } finally {
                grantBtn.disabled = false;
                grantBtn.innerHTML = '<span>💵</span> Check Grants';
            }
        });
    }

    // Full Discovery
    const fullBtn = document.getElementById('runFullDiscovery');
    if (fullBtn) {
        fullBtn.addEventListener('click', async () => {
            if (!confirm('Full discovery may take several minutes. Continue?')) return;
            
            fullBtn.disabled = true;
            fullBtn.innerHTML = '<span class="spinner" style="width: 14px; height: 14px;"></span> Running comprehensive discovery...';
            
            try {
                const response = await fetch(`${API_BASE}/discovery/comprehensive`, {
                    method: 'POST'
                });
                
                if (!response.ok) throw new Error('Discovery failed');
                
                const result = await response.json();
                
                showSuccess(`
                    Discovery complete! Found:
                    ${result.stats.newCompounds} compounds,
                    ${result.stats.newPatents} patents,
                    ${result.stats.newGrants} grants,
                    ${result.stats.newPublications} publications,
                    ${result.stats.totalSignals} total signals
                `);
                
                await loadDiscoveryStats();
                await loadDiscoverySignals();
                
            } catch (error) {
                showError('Comprehensive discovery failed');
            } finally {
                fullBtn.disabled = false;
                fullBtn.innerHTML = '<span>🚀</span> Run Full Discovery';
            }
        });
    }
}

// ============= TAB SWITCHING =============

function setupDiscoveryTabs() {
    const tabButtons = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');
    
    tabButtons.forEach(button => {
        button.addEventListener('click', () => {
            const targetTab = button.dataset.tab;
            
            // Update active states
            tabButtons.forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            
            // Show corresponding content
            tabContents.forEach(content => {
                if (content.id === `${targetTab}-content`) {
                    content.style.display = 'block';
                    
                    // Load data for specific tabs
                    if (targetTab === 'compounds') {
                        loadEarlyCompounds();
                    } else if (targetTab === 'companies') {
                        loadPrePhase1Companies();
                    } else if (targetTab === 'timeline') {
                        loadDiscoveryTimeline();
                    }
                } else {
                    content.style.display = 'none';
                }
            });
        });
    });
}

async function loadPrePhase1Companies() {
    // Load companies with pre-Phase 1 signals
    try {
        const response = await fetch(`${API_BASE}/leads?pageSize=100`);
        if (!response.ok) throw new Error('Failed to fetch companies');
        
        const data = await response.json();
        const tbody = document.getElementById('prePhase1CompaniesBody');
        if (!tbody) return;

        // Filter for companies with pre-phase 1 signals
        const companiesWithSignals = [];
        
        for (const company of data.leads) {
            const detailResponse = await fetch(`${API_BASE}/leads/${company.id}`);
            if (detailResponse.ok) {
                const details = await detailResponse.json();
                const prePhase1Signals = details.signals.filter(s => 
                    ['new_compound', 'early_patent', 'grant', 'publication'].includes(s.signal_type)
                );
                
                if (prePhase1Signals.length > 0) {
                    companiesWithSignals.push({
                        ...company,
                        signalCount: prePhase1Signals.length,
                        latestSignal: prePhase1Signals[0]
                    });
                }
            }
        }

        tbody.innerHTML = companiesWithSignals.map(company => `
            <tr>
                <td>
                    <div class="company-info">
                        <div class="company-avatar">${getInitials(company.name)}</div>
                        <div class="company-details">
                            <div class="company-name" data-company-id="${company.id}">${escapeHtml(company.name)}</div>
                        </div>
                    </div>
                </td>
                <td><strong>${company.signalCount}</strong></td>
                <td>${company.molecule_count || 0}</td>
                <td>-</td>
                <td>-</td>
                <td>${company.latestSignal ? new Date(company.latestSignal.date).toLocaleDateString() : '-'}</td>
                <td><span class="score-badge tier-b">${((company.signalCount || 0) * 5).toFixed(0)}</span></td>
                <td>
                    <button class="btn-action view-company" data-company-id="${company.id}">View</button>
                </td>
            </tr>
        `).join('');
        
    } catch (error) {
        console.error('Error loading pre-Phase 1 companies:', error);
    }
}

async function loadCompounds() {
    setContentLoading("Loading early compounds...");
    try {
        const res = await fetch(`${API_BASE}/discovery/compounds`);
        const data = await res.json();
        renderCompoundsTable(data.compounds || []);
    } catch (err) {
        console.error("Error loading compounds:", err);
        setContentError("Failed to load compounds");
    }
}
function renderCompoundsTable(compounds) {
    if (!compounds.length) {
        setContentEmpty("No new compounds found.");
        return;
    }
    const rows = compounds.map(c => `
        <tr>
            <td>${c.company}</td>
            <td>${c.substance.sid}</td>
            <td>${c.substance.cid || "-"}</td>
            <td>${c.substance.depositor_name}</td>
            <td>${c.substance.submission_date}</td>
        </tr>
    `).join("");

    document.getElementById("contentArea").innerHTML = `
        <h1 class="page-title">Early Compounds</h1>
        <div class="data-table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Company</th>
                        <th>SID</th>
                        <th>CID</th>
                        <th>Depositor</th>
                        <th>Submission Date</th>
                    </tr>
                </thead>
                <tbody>${rows}</tbody>
            </table>
        </div>
    `;
}

function renderPatentsTable(patents) {
    if (!patents.length) {
        setContentEmpty("No patents found.");
        return;
    }
    const rows = patents.map(p => `
        <tr>
            <td>${p.company}</td>
            <td>${p.patent}</td>
            <td>${p.title}</td>
        </tr>
    `).join("");

    document.getElementById("contentArea").innerHTML = `
        <h1 class="page-title">Early Patents</h1>
        <div class="data-table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Company</th>
                        <th>Patent Number</th>
                        <th>Title</th>
                    </tr>
                </thead>
                <tbody>${rows}</tbody>
            </table>
        </div>
    `;
}

function renderGrantsTable(grants) {
    if (!grants.length) {
        setContentEmpty("No grants found.");
        return;
    }
    const rows = grants.map(g => `
        <tr>
            <td>${g.company || "-"}</td>
            <td>${g.grant_id}</td>
            <td>${g.agency}</td>
            <td>${g.title}</td>
            <td>${g.amount ? "$" + g.amount.toLocaleString() : "-"}</td>
        </tr>
    `).join("");

    document.getElementById("contentArea").innerHTML = `
        <h1 class="page-title">NIH Grants</h1>
        <div class="data-table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Company</th>
                        <th>Grant ID</th>
                        <th>Agency</th>
                        <th>Title</th>
                        <th>Amount</th>
                    </tr>
                </thead>
                <tbody>${rows}</tbody>
            </table>
        </div>
    `;
}
function setContentLoading(msg = "Loading...") {
    document.getElementById("contentArea").innerHTML = `
        <div class="loading"><div class="spinner"></div><span>${msg}</span></div>
    `;
}

function setContentError(msg) {
    document.getElementById("contentArea").innerHTML = `
        <div class="empty-state">
            <div class="empty-icon">⚠️</div>
            <div class="empty-title">Error</div>
            <div class="empty-text">${msg}</div>
        </div>
    `;
}

function setContentEmpty(msg) {
    document.getElementById("contentArea").innerHTML = `
        <div class="empty-state">
            <div class="empty-icon">ℹ️</div>
            <div class="empty-title">No Data</div>
            <div class="empty-text">${msg}</div>
        </div>
    `;
}

async function loadPatents() {
    setContentLoading("Loading early patents...");
    try {
        const res = await fetch(`${API_BASE}/discovery/patents`);
        const data = await res.json();
        renderPatentsTable(data.patents || []);
    } catch (err) {
        console.error("Error loading patents:", err);
        setContentError("Failed to load patents");
    }
}

async function loadGrants() {
    setContentLoading("Loading NIH grants...");
    try {
        const res = await fetch(`${API_BASE}/discovery/grants`);
        const data = await res.json();
        renderGrantsTable(data.grants || []);
    } catch (err) {
        console.error("Error loading grants:", err);
        setContentError("Failed to load grants");
    }
}


async function loadDiscoveryTimeline() {
    const container = document.getElementById('discoveryTimeline');
    if (!container) return;
    
    container.innerHTML = `
        <div style="padding: 48px; text-align: center;">
            <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 16px;">Discovery Timeline</h3>
            <div style="text-align: left; max-width: 600px; margin: 0 auto;">
                <div class="timeline-item" style="margin-bottom: 24px; padding-left: 24px; border-left: 2px solid #e5e7eb;">
                    <div style="margin-left: -30px; width: 12px; height: 12px; background: #3b82f6; border-radius: 50%;"></div>
                    <div style="margin-top: -20px;">
                        <strong>Today</strong> - Run comprehensive discovery
                    </div>
                </div>
                <div class="timeline-item" style="margin-bottom: 24px; padding-left: 24px; border-left: 2px solid #e5e7eb;">
                    <div style="margin-left: -30px; width: 12px; height: 12px; background: #10b981; border-radius: 50%;"></div>
                    <div style="margin-top: -20px;">
                        <strong>Yesterday</strong> - 3 new compounds discovered
                    </div>
                </div>
                <div class="timeline-item" style="padding-left: 24px;">
                    <div style="margin-left: -30px; width: 12px; height: 12px; background: #f59e0b; border-radius: 50%;"></div>
                    <div style="margin-top: -20px;">
                        <strong>Last Week</strong> - 12 patents filed
                    </div>
                </div>
            </div>
        </div>
    `;
}
</script>

</body>
</html>